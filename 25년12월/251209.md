# 251209





```
@Component
@ConditionalOnProperty(
        prefix = "batch.test",
        name = "fail-job-enabled",
        havingValue = "true"
)
@RequiredArgsConstructor
public class FailJobTestRunner implements CommandLineRunner {

    private final JobLauncher jobLauncher;
    private final Job failTestJob;

    @Override
    public void run(String... args) throws Exception {
        JobParameters params = new JobParametersBuilder()
                .addLong("timestamp", System.currentTimeMillis())
                .addString("reason", "sms-fail-test")
                .toJobParameters();

        jobLauncher.run(failTestJob, params);
    }
}

```



- yaml내용 추가

```
batch:
  test:
    fail-job-enabled: false

```

- jar 기동(실제 jar를 대상으로 할때)
  - 실패하는 fail-job을 실행하려고 Option을 줄경우

```
java -Dspring.profiles.active=local \
     -jar target/batch.jar \
     --batch.test.fail-job-enabled=true
    
```



```
--batch.test.fail-job-enabled=true
--batct.test.success-job-enabled=true
```





- 크론에서 jar기동하려고 할때

```
java 
-Dspring.profiles.active=prod
-jar batch.jar
--spring.batch.job.names=wooriBankCardJob

```

- job이 여러개일때는 컴마로 구분도 가능

```
java
-Dspring.profiles.active=prod
-jar batch.jar
--spring.batch.job.names=jobA,jobB,jobC
```



---





- Job 실패시 SMS를 전송하려고 한다.
- 현재 1개를 제외하곤 RunTime계열을 던지는게 없다.
  - 해당 RunTime계열도 Validation개념으로 딱 1회 던진다.
- Reader, Processor, Writer내부에서는 DB I/O작업이 전부이다.
- FailRecodingSkipListener에서 위 Step내부에서 예외 발생시에는 TbBatchFailItem에 기록을한다.
- 문제는 SqlException, DBConnectionPool에러, 네트워크 I/O등 Batch 내부에서 제어할 수 없는 것이다.
- 해당 Batch는 5분에 한 번씩 돌고있는데, 위와 같이 실패할때마다 모든 내용이 SMS로 전송이 되면 문제가 된다.
- 따라서 동일한 Job에 대해서 동일한 예외에 대해서는 SMS전송이 되지 않도록 BatchAlertService를 구성했다.
- TbBatchAlertState를 통해서 개념적으로 Redis Key로 Lock을 건다. 
- Key는 현재 ErrorSignature를 통해 구성한다. 
- 그러나, 위에서 언급한 것처럼 Step의 Chunk밖에서 예외가 터진 경우에는 TbBatchFailItem에 기록이 안되고 있으며, 이에 따라 ErrorSignature를 생성할때 Key값도 별도로 생성해줘야한다.
- 현재와 같이 작성되어 있는 상황에서는 동일한 예외가 지속해서 같은 순서로 발생하면 메시지가 지속해서 발송되지 않고 1회만 발송이 되며, Batch작업이 정상적으로 해결되면 문제가 해결된다.
- 그러나 예외가 abc로 발생했다가 cbabcabcdea와같이 순서가 지속해서 변경된다면 어쨋든 문자는 계속해서 발송이 될것이다.
- 위와 같은 고려가 지나친 것인지 아니면 새롭게 방법을 강구해야할지, 그리고 강구한다면 어떻게 해줘야할지를 고려해줘.
