# 260223



### B-Tree 탐색비용

- MYSQL에서  Index는 B-Tree구조를 생성되어있다.
- B-Tree에서 리프노드까지 탐색비용은 'O(logN)'
- N개의 row가 있다고할때, 따라서 Index의 쓰기 비용은 O(NLogN)
  - 여기서 Page Split비용은 상수이므로 무시한다.
- 임의의 Table에 Row가 추가될때, 해당 Table에 K개의 Secodary Index가 있다고 하면 비용은 다음과 같다.
  - O(K*N * Log N)
- 그러나 위 비용은 일반적으로 DML에서의 인덱스가 추가될때의 비용을 의미한다.
- 해당 과정은 '하향식 접근 방식을' 뜻한다
  - 하향식이라고 표현하는 이유는 B-Tree의 루트노드에서부터 리프노드까지 아래로 내려가면서 B-Tree의 노드를 추가하기 때문이다. 



### Sorted Index Build(Bulk Load For Index)

- MYSQL 5.7부터는 '상향식 접근 방식'을 사용하여 Inno DB의 Secondary Index를 생성할수 있다.
  - 상향식 접근방식이란, 루트노드에서부터 리프노드로 접근하는 것이 아니라 정렬된 인덱스를 생성하여 리프노드에서부터 루트노드로 오름차순식으로 정렬된 상태로 접근하는 것을 뜻한다.
- Sorted Index Builld는 항상 사용되는 것이 아니라 다음과 같은 경우에 사용된다.

```
ALTER TABLE t1 ADD INDEX(OR CREATE INDEX)
ALTER TABLE t1 ADD FULLTEXT INDEX
ALTER TABLE t1 ADDD COLUMN,ALGOTITHM=INPLACE
OPTIMZE TALBE t1
```

- spatial Index에 대해서는 지원 X
- Secondary Index 생성시에, Clusted Index를 스캔한 후 인덱스 항목이 생성되어 Sort Buffer에 추가된다.
  - Sort Buffer는 Inno DB Buffer Pool과는 별개의 영역이다. 
  - Sort Buffer가 꽉 차게되면 항목들이 정렬이 되고 임시 중간파일에 쓰여지는데, 이 과정을 'run'이라고 한다.
  - 하나 이상의 run이 임시 중간 파일에 쓰여지면, 병합정렬이 모든 파일에 걸쳐서 수행된다.
  - 정렬된 항목들이 B-Tree에 삽입이 된다.

참조

https://jjon.tistory.com/entry/MySQL-sorted-index-%EC%83%9D%EC%84%B1



### Page 구조



![MySQL Storage Structure. The storage hierarchy is organized from… | by Ruby  Lai | Medium](https://miro.medium.com/v2/resize:fit:1144/0*HiKFqFMoCdqb-hiF)

MySQL의 Inno DB의 Page는 위의 그림과 같은 구조로 생성되어있다.

크게 중요한 것은 File Header/ Page Header / Record이다.

- File Header

  - Page에 대한 기본정보
  - 이전/다음 페이지를 가리키는 포인터
  - 여기서 말하는 '포인터'는 같은 레벨에 있는 형제레벨의 페이지를 연결하는 포인터
  - 이건 'Range Scan'을 위한 구조

- Page Header

  - 파일의 타입을 구분
  - Data Page / Index Page / Undo Page

- Record

  - 논리적으로는 단방향 링크드리스트 형태로 연결되어 정렬되어있으나

  - 물리적으로는 정렬되어있지 않다.
  - 여기서 '연결과 정렬' 은 Page 내의 Record가 연결되고 정렬되어있다는 것을 말한다.

- Page
  - 64page가 모여서 하나의 'Extent'를 구성
  - 'Extent' -> 'Segment' ->  'Table' -> 1개 이상의 Table이 모여서 .ibd File로 저장이된다.

### B-Tree

- Root - Branch - Leaf Node로 구성

- 하나의 Node에 N개의 Page가 들어있다.

- 깊이가 얕고 너비가 넓음

  - 탐색하는데 유리하며 이에 따라 Range Scan에 유리

    







![image-20260223133547524](D:\Typora\images\image-20260223133547524.png)

### Data 저장과정

1. Buffer에 Insert할 Page를 Load
   - Buffer Pool에 해당하는 page가 있으면 Buffer에서 로드
   - Buffer에 없는 경우 Disk에서 조회해서 로드
   - Buffer또는 Disk에 동일한 PK가 있으면 예외 발생
     - <- PK는 Unique해야하므로 
2. Redo Log Write
3. 해당 Page에 insert
4. CheckPoint Event Or Dirty Page의 비율이 일정비율 이상이면 Disk로 Flush
5. Secondary Index는 위 과정을 비동기적으로 수행





