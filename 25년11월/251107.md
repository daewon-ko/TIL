# 251107



### 쿠키와 토큰

- 하나의 도메인에 포트별로 여러 서버를 띄운다.

  - 각 포트의 서버는 각자의 인증 시스템을 지니고 있다.
  - 각 인증시스템이란 accessToken을 발급하는 것이다.
  - 발급된 토큰은 '쿠키'에 저장되어 이용된다.

- 호스트 주소( ex. 192.168.0.250)이 동일한 상태에서 쿠키 내에 각 포트가 다르게 띄워진 서버에서 발급한 쿠키가 존재한다.

  - 도메인명별로 쪼개져있지 않은 상태이다.
  - 아래의 각 개별적 서버의 인가필터 로직에서 다음과 같이 동작한다.

  ```
  dofilterInternal(HttpServletRequest request, HttpServletResponse response){
  	String token = null;
  	if(path.startWith("/특정경로")){
  		if(request.getCookies()! = null){
  			// Cookie에 있는 Iteration수행
  			// Cookie에서 "accessToken"이 있으면 꺼내서 할당
  			if("accessToken".equals.(cookie.getName()))
  				token = cookie.getValue();
  				break;
  		}
  	}
  
  
  
  }
  ```

- 문제는 Cookie 내에 accessToken이라는 이름으로 각 개별적 포트에 띄워져있는 서버에서 발급한 토큰이 존재한다면, 서버 입장에서는 내가 받은 쿠키의 이름이 같다면 어떻게 구분하지?

  - -> RT(Refresh Token)을 적절하게 발급해주거나
    - RT자체는 근본적 해결책 X
  - PATH를 서버별로 설정한다
    - 8000번 포트 서버의 PATH
      - "/app/admin"
    - 8001번 포트 서버의 PATH
      - "/app/chat"
    - Cookie의 'PATH'를 설정해줄때 토큰 발급시 각 PATH를 지정해주면 가능
  - 서브도메인을 분리해야한다.
  - ![image-20251107152926798](D:\Typora\images\image-20251107152926798.png)

  - naver는 쿠키에서 서브도메인을 나눈 것을 확인할 수 있음

### JWT 토큰 탈취시

- Http Only Cookie 사용
- 블랙리스트 토큰 저장
- Refresh Token 저장
  - Refresh Token Rotation
    - RefreshToken을 1회용으로 사용하는 것